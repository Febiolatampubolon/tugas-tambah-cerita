const u="story-catalog-static-v1",a="story-catalog-dynamic-v1",h=["/","/index.html","/scripts/index.js","/styles/styles.css","/manifest.json","/images/story.png","/images/icon-512x512.png","https://unpkg.com/leaflet@1.9.4/dist/leaflet.css","https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"];self.addEventListener("install",n=>{console.log("Service Worker: Installing..."),n.waitUntil(caches.open(u).then(e=>(console.log("Service Worker: Caching static assets"),e.addAll(h))).then(()=>self.skipWaiting()).catch(e=>{console.error("Service Worker: Failed to cache static assets",e)}))});self.addEventListener("activate",n=>{console.log("Service Worker: Activating..."),n.waitUntil(caches.keys().then(e=>Promise.all(e.map(t=>{if(t!==u&&t!==a)return console.log("Service Worker: Deleting old cache",t),caches.delete(t)}))).then(()=>self.clients.claim()))});self.addEventListener("fetch",n=>{const{request:e}=n,t=new URL(e.url);if(e.method==="GET"){if(t.origin==="https://story-api.dicoding.dev"){n.respondWith(caches.open(a).then(i=>fetch(e).then(o=>{if(o.status===200){const s=o.clone();i.put(e,s).catch(c=>{console.warn("Failed to cache API response:",c)})}return o}).catch(()=>i.match(e).then(o=>o?(console.log("Serving cached API response for:",e.url),o):new Response(JSON.stringify({error:!0,message:"You are offline. Please check your connection."}),{status:503,headers:{"Content-Type":"application/json"}})))));return}n.respondWith(fetch(e).then(i=>{if(e.url.startsWith(self.location.origin)&&i.status===200){const o=i.clone();caches.open(a).then(s=>{s.put(e,o).catch(c=>{console.warn("Failed to cache response:",c)})})}return i}).catch(()=>caches.match(e).then(i=>{var o;return i||(e.destination==="document"||(o=e.headers.get("accept"))!=null&&o.includes("text/html")?caches.match("/index.html"):new Response("Offline - No cached content available",{status:503,statusText:"Service Unavailable",headers:{"Content-Type":"text/plain"}}))})))}});self.addEventListener("push",n=>{console.log("Service worker pushing...");async function e(){var s,c,r,l,d;let t={title:"New Notification",options:{body:"New data has been added."}};if(n.data)try{t=await n.data.json(),console.log("Push data received:",t)}catch{console.log("No JSON data in push, using default")}const i=t.title||"New Notification",o=((s=t.options)==null?void 0:s.body)||t.body||"New data has been added.";await self.registration.showNotification(i,{body:o,icon:((c=t.options)==null?void 0:c.icon)||"/images/story.png",badge:((r=t.options)==null?void 0:r.badge)||"/images/story.png",data:((l=t.options)==null?void 0:l.data)||{},tag:((d=t.options)==null?void 0:d.tag)||"story-notification",vibrate:[200,100,200],requireInteraction:!0,actions:[{action:"view",title:"View"},{action:"close",title:"Close"}]})}n.waitUntil(e())});self.addEventListener("notificationclick",n=>{console.log("Service Worker: Notification click event",n),n.notification.close();const e=n.action,t=n.notification.data;if(e==="close")return;let i=(t==null?void 0:t.url)||"/#/stories";e==="view"&&(t!=null&&t.storyId)&&(i=`/#/stories/${t.storyId}`),n.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then(o=>{for(const s of o)if(s.url.includes(i.split("#")[1])&&"focus"in s)return s.focus();if(o.openWindow){const s=self.location.origin;return o.openWindow(s+i)}}))});self.addEventListener("sync",n=>{console.log("Service Worker: Background sync event",n.tag),n.tag==="background-sync"&&n.waitUntil(Promise.resolve().then(()=>{console.log("Background sync completed")}))});
